<div class="clases-container">
  <!-- Header General - Using HeaderComponent -->
  <app-header #headerComponent></app-header>

  <!-- Estado de Carga -->
  <div *ngIf="cargando" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Cargando informaci√≥n de clases...</p>
  </div>

  <!-- Estado de Error -->
  <div *ngIf="error && !cargando" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Error al cargar las clases</h3>
    <p>No se pudo cargar la informaci√≥n de las clases. Por favor intente nuevamente.</p>
    <button class="btn-primary" (click)="cargarClases()">Reintentar</button>
  </div>

  <!-- Contenido Principal -->
  <div *ngIf="!cargando && !error">
    <!-- Estad√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìö</div>
        <div class="stat-content">
          <h3>{{ totalClases }}</h3>
          <p>Total Clases</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <h3>{{ clasesPendientes }}</h3>
          <p>Pendientes</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3>{{ clasesAsignadas }}</h3>
          <p>Asignadas</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-content">
          <h3>{{ clasesCanceladas }}</h3>
          <p>Canceladas</p>
        </div>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filters-card">
      <div class="filter-group">
        <label for="filtroEstado">Estado</label>
        <select id="filtroEstado" 
                [(ngModel)]="filtroEstado" 
                (ngModelChange)="filtrarClases()">
          <option value="Todos">Todos</option>
          <option value="PENDIENTE">‚è≥ Pendiente</option>
          <option value="ASIGNADO">‚úÖ Asignado</option>
          <option value="CANCELADO">‚ùå Cancelado</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtroCategoria">Categor√≠a</label>
        <select id="filtroCategoria" 
                [(ngModel)]="filtroCategoria" 
                (ngModelChange)="filtrarClases()">
          <option value="Todos">Todos</option>
          <option *ngFor="let categoria of categorias" [value]="categoria">
            {{ categoria }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtroPrioridadMin">Prioridad M√≠nima</label>
        <input type="number" 
               id="filtroPrioridadMin" 
               [(ngModel)]="filtroPrioridadMin" 
               min="0"
               max="10"
               (input)="validarPrioridad($event, 'min')"
               (blur)="validarPrioridad($event, 'min')"
               placeholder="0" />
      </div>

      <div class="filter-group">
        <label for="filtroPrioridadMax">Prioridad M√°xima</label>
        <input type="number" 
               id="filtroPrioridadMax" 
               [(ngModel)]="filtroPrioridadMax" 
               min="0"
               max="10"
               (input)="validarPrioridad($event, 'max')"
               (blur)="validarPrioridad($event, 'max')"
               placeholder="10" />
      </div>

      <div class="acciones-filtros">
        <div class="botones-filtro">
          <button class="btn-primary" (click)="resetearFiltros()">
            Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla de Clases -->
    <div class="clases-table-container">
      <div class="table-header">
        <h2>Lista de Clases</h2>
        <div class="actions">
          <input type="text" 
                 [(ngModel)]="textoBusqueda" 
                 (ngModelChange)="filtrarClases()"
                 placeholder="Buscar por programa, categor√≠a, paralelo u horario..." />
          
          <!-- Bot√≥n agregar solo para clases activas -->
          <button class="btn-primary" (click)="abrirModalCreacion()">
            <img src="img/mas.png" alt="Agregar" class="btn-icon" />
            Agregar Clase
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="clases-table">
          <thead>
            <tr>
              <th>Programa</th>
              <th>Categor√≠a</th>
              <th>Paralelo</th>
              <th>Cupos</th>
              <th>Horario</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="clasesPaginadas.length === 0">
              <td colspan="9" class="no-data">
                <div class="no-data-content">
                  <p>No se encontraron clases que coincidan con los filtros aplicados.</p>
                </div>
              </td>
            </tr>
            <tr *ngFor="let clase of clasesPaginadas; let i = index">
              <td>
                <strong>{{ clase.programa?.nombre }}</strong>
              </td>
              <td>
                <span class="categoria-badge" [ngClass]="getCategoriaClass(clase.programa?.categoria)">
                  {{ clase.programa?.categoria }}
                </span>
              </td>
              <td>
                <span class="paralelo-badge">{{ clase.paralelo }}</span>
              </td>
              <td>{{ clase.cupos_proyectados }} estudiantes</td>
              <td>{{ clase.horario_solicitado }}</td>
              <td>
                <span class="estado-badge" [ngClass]="getEstadoClass(clase.estado)">
                  {{ getEstadoTexto(clase.estado) }}
                </span>
              </td>
              <td>
                <span class="prioridad-badge" [ngClass]="getPrioridadClass(clase.prioridad)">
                  {{ clase.prioridad }}
                </span>
              </td>
              <td>
                <span class="observaciones" *ngIf="clase.observaciones">
                  {{ clase.observaciones }}
                </span>
                <span class="sin-observaciones" *ngIf="!clase.observaciones">
                  Sin observaciones
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-view" (click)="verClase(i)" title="Ver Clase">
                    <img src="img/ojo-abierto.png" alt="Ver" width="20" />
                  </button>
                  <button class="btn-edit" (click)="editarClase(clase)" title="Editar Clase">
                    <img src="img/edicion.png" alt="Editar" class="btn-icon" />
                  </button>
                  <button class="btn-delete" (click)="eliminarClase(clase)" title="Eliminar Clase">
                    <img src="img/eliminar.png" alt="Eliminar" class="btn-icon" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- PAGINACI√ìN -->
      <div class="pagination" *ngIf="totalPaginas > 1">
        <div class="pagination-info">
          <span>Mostrando {{ obtenerRangoPagina().inicio }} - {{ obtenerRangoPagina().fin }} de {{ obtenerRangoPagina().total }} clases</span>
        </div>
        
        <div class="pagination-controls">
          <button class="btn-pagination" 
                  [disabled]="paginaActual === 1" 
                  (click)="cambiarPagina(paginaActual - 1)">
            ‚Üê Anterior
          </button>
          
          <div class="page-numbers">
            <button *ngFor="let pagina of obtenerPaginasVisibles()" 
                    class="btn-page" 
                    [class.active]="pagina === paginaActual"
                    (click)="cambiarPagina(pagina)">
              {{ pagina }}
            </button>
          </div>
          
          <button class="btn-pagination" 
                  [disabled]="paginaActual === totalPaginas" 
                  (click)="cambiarPagina(paginaActual + 1)">
            Siguiente ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL VER DETALLES -->
  <div class="modal-backdrop" *ngIf="mostrarModalVista">
    <div class="modal-vista">
      <div class="modal-header">
        <h3>Detalle de la Clase</h3>
        <button class="btn-close" (click)="cerrarModalVista()">√ó</button>
      </div>
      
      <div class="modal-content" *ngIf="claseSeleccionada">
        
        <div class="info-section">
          <h4>Informaci√≥n del Programa</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Programa:</label>
              <span class="programa-nombre">{{ claseSeleccionada.programa?.nombre }}</span>
            </div>
            <div class="info-item">
              <label>Categor√≠a:</label>
              <span class="categoria-badge" [ngClass]="getCategoriaClass(claseSeleccionada.programa?.categoria)">
                {{ claseSeleccionada.programa?.categoria }}
              </span>
            </div>
            <div class="info-item">
              <label>Paralelo:</label>
              <span class="paralelo-badge">{{ claseSeleccionada.paralelo }}</span>
            </div>
            <div class="info-item">
              <label>Cupos Proyectados:</label>
              <span>{{ claseSeleccionada.cupos_proyectados }} estudiantes</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h4>Horario y Estado</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Horario Solicitado:</label>
              <span>{{ claseSeleccionada.horario_solicitado }}</span>
            </div>
            <div class="info-item">
              <label>Estado:</label>
              <span class="estado-badge" [ngClass]="getEstadoClass(claseSeleccionada.estado)">
                {{ getEstadoTexto(claseSeleccionada.estado) }}
              </span>
            </div>
            <div class="info-item">
              <label>Prioridad:</label>
              <span class="prioridad-badge" [ngClass]="getPrioridadClass(claseSeleccionada.prioridad)">
                {{ claseSeleccionada.prioridad }}
              </span>
            </div>
          </div>
        </div>

        <div class="info-section" *ngIf="claseSeleccionada.observaciones">
          <h4>Observaciones</h4>
          <div class="info-item">
            <label>Notas Adicionales:</label>
            <span class="observaciones-texto">{{ claseSeleccionada.observaciones }}</span>
          </div>
        </div>

        <div class="info-section">
          <h4>Informaci√≥n del Sistema</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Fecha de Creaci√≥n:</label>
              <span>{{ claseSeleccionada.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="info-item">
              <label>ID de la Clase:</label>
              <span class="id-clase">{{ claseSeleccionada.id }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR CLASE -->
  <div class="modal-backdrop" *ngIf="mostrarModalEdicion">
    <div class="modal-edicion">
      <div class="modal-header">
        <h3>Editar Clase</h3>
        <button class="btn-close" (click)="cerrarModalEdicion()">√ó</button>
      </div>
      
      <div class="modal-content" *ngIf="claseEditando">
        <form (ngSubmit)="guardarClase()" #editForm="ngForm">
          
          <!-- Informaci√≥n B√°sica -->
          <div class="form-section">
            <h4>Informaci√≥n B√°sica</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="programa_id">Programa *</label>
                <select id="programa_id"
                        name="programa_id"
                        [(ngModel)]="claseEditando.programa_id"
                        required
                        class="form-control">
                  <option *ngFor="let programa of programas" [value]="programa.id">
                    {{ programa.nombre }}
                  </option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="cupos_proyectados">Cupos Proyectados *</label>
                <input type="number" 
                       id="cupos_proyectados" 
                       name="cupos_proyectados"
                       [(ngModel)]="claseEditando.cupos_proyectados" 
                       min="1"
                       required
                       class="form-control" />
              </div>
              
              <div class="form-group">
                <label for="paralelo">Paralelo *</label>
                <input type="text" 
                       id="paralelo" 
                       name="paralelo"
                       [(ngModel)]="claseEditando.paralelo" 
                       required
                       class="form-control" />
              </div>
              
              <div class="form-group">
                <label for="prioridad">Prioridad *</label>
                <input type="number" 
                       id="prioridad" 
                       name="prioridad"
                       [(ngModel)]="claseEditando.prioridad" 
                       min="1"
                       max="10"
                       required
                       class="form-control" />
              </div>
            </div>
          </div>

          <!-- Horario y Estado -->
          <div class="form-section">
            <h4>Horario y Estado</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="horario_solicitado">Horario Solicitado *</label>
                <input type="text" 
                       id="horario_solicitado" 
                       name="horario_solicitado"
                       [(ngModel)]="claseEditando.horario_solicitado" 
                       required
                       class="form-control"
                       placeholder="Ej: lunes-viernes 14:00-15:00" />
              </div>
              
              <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" 
                        name="estado"
                        [(ngModel)]="claseEditando.estado" 
                        class="form-control">
                  <option value="PENDIENTE">‚è≥ Pendiente</option>
                  <option value="ASIGNADO">‚úÖ Asignado</option>
                  <option value="CANCELADO">‚ùå Cancelado</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="form-section">
            <h4>Observaciones</h4>
            <div class="form-group">
              <label for="observaciones">Notas Adicionales</label>
              <textarea id="observaciones" 
                        name="observaciones"
                        [(ngModel)]="claseEditando.observaciones" 
                        rows="3"
                        class="form-control"
                        placeholder="Descripci√≥n adicional de la clase..."></textarea>
            </div>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="form-actions">
            <button type="button" 
                    class="btn-secondary" 
                    (click)="cerrarModalEdicion()">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary" 
                    [disabled]="!editForm.valid || guardando">
              {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL CREAR CLASE -->
  <div class="modal-backdrop" *ngIf="mostrarModalCreacion">
    <div class="modal-creacion">
      <div class="modal-header">
        <h3>Crear Nueva Clase</h3>
        <button class="btn-close" (click)="cerrarModalCreacion()">√ó</button>
      </div>
      
      <div class="modal-content" *ngIf="nuevaClase">
        <form (ngSubmit)="crearClase()" #createForm="ngForm">
          
          <!-- Informaci√≥n B√°sica -->
          <div class="form-section">
            <h4>Informaci√≥n B√°sica</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="nuevo_programa_id">Programa *</label>
                <select id="nuevo_programa_id"
                        name="programa_id"
                        [(ngModel)]="nuevaClase.programa_id"
                        required
                        class="form-control">
                  <option *ngFor="let programa of programas" [value]="programa.id">
                    {{ programa.nombre }}
                  </option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="nuevo_cupos_proyectados">Cupos Proyectados *</label>
                <input type="number" 
                       id="nuevo_cupos_proyectados" 
                       name="cupos_proyectados"
                       [(ngModel)]="nuevaClase.cupos_proyectados" 
                       min="1"
                       required
                       class="form-control" />
              </div>
              
              <div class="form-group">
                <label for="nuevo_paralelo">Paralelo *</label>
                <input type="text" 
                       id="nuevo_paralelo" 
                       name="paralelo"
                       [(ngModel)]="nuevaClase.paralelo" 
                       required
                       class="form-control" />
              </div>
              
              <div class="form-group">
                <label for="nuevo_prioridad">Prioridad *</label>
                <input type="number" 
                       id="nuevo_prioridad" 
                       name="prioridad"
                       [(ngModel)]="nuevaClase.prioridad" 
                       min="1"
                       max="10"
                       required
                       class="form-control" />
              </div>
            </div>
          </div>

          <!-- Horario y Estado -->
          <div class="form-section">
            <h4>Horario y Estado</h4>
            <div class="form-grid">
              <div class="form-group">
                <label for="nuevo_horario_solicitado">Horario Solicitado *</label>
                <input type="text" 
                       id="nuevo_horario_solicitado" 
                       name="horario_solicitado"
                       [(ngModel)]="nuevaClase.horario_solicitado" 
                       required
                       class="form-control"
                       placeholder="Ej: lunes-viernes 14:00-15:00" />
              </div>
              
              <div class="form-group">
                <label for="nuevo_estado">Estado</label>
                <select id="nuevo_estado" 
                        name="estado"
                        [(ngModel)]="nuevaClase.estado" 
                        class="form-control">
                  <option value="PENDIENTE">‚è≥ Pendiente</option>
                  <option value="ASIGNADO">‚úÖ Asignado</option>
                  <option value="CANCELADO">‚ùå Cancelado</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="form-section">
            <h4>Observaciones</h4>
            <div class="form-group">
              <label for="nuevo_observaciones">Notas Adicionales</label>
              <textarea id="nuevo_observaciones" 
                        name="observaciones"
                        [(ngModel)]="nuevaClase.observaciones" 
                        rows="3"
                        class="form-control"
                        placeholder="Descripci√≥n adicional de la clase..."></textarea>
            </div>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="form-actions">
            <button type="button" 
                    class="btn-secondary" 
                    (click)="cerrarModalCreacion()">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn-primary" 
                    [disabled]="!createForm.valid || creando">
              {{ creando ? 'Creando...' : 'Crear Clase' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 